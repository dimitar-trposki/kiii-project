apiVersion: v1
kind: ConfigMap
metadata:
  name: initsql
  namespace: bookeshop
data:
  init.sql: |
    CREATE TABLE country
    (
        id        bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name      VARCHAR(255) NOT NULL,
        continent VARCHAR(255) NOT NULL
    );

    CREATE TABLE author
    (
        id         bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name       VARCHAR(255) NOT NULL,
        surname    VARCHAR(255) NOT NULL,
        country_id BIGINT REFERENCES country (id)
    );

    CREATE TABLE book
    (
        id               bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name             VARCHAR(255) NOT NULL,
        category         VARCHAR(255) NOT NULL,
        author_id        BIGINT REFERENCES author (id),
        available_copies INT,
        is_deleted       BOOLEAN DEFAULT FALSE,
        date_created     TIMESTAMP
    );

    CREATE TABLE book_users
    (
        username                   VARCHAR(255) PRIMARY KEY,
        password                   VARCHAR(255) NOT NULL,
        name                       VARCHAR(255) NOT NULL,
        surname                    VARCHAR(255) NOT NULL,
        is_account_non_expired     BOOLEAN DEFAULT TRUE,
        is_account_non_locked      BOOLEAN DEFAULT TRUE,
        is_credentials_non_expired BOOLEAN DEFAULT TRUE,
        is_enabled                 BOOLEAN DEFAULT TRUE,
        role                       VARCHAR(255)
    );

    CREATE TABLE wishlist
    (
        id              bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        date            TIMESTAMP,
        user_username   VARCHAR(255),
        wishlist_status VARCHAR(255),
        CONSTRAINT fk_wishlist_user FOREIGN KEY (user_username) REFERENCES book_users (username)
    );

    CREATE TABLE wishlist_books
    (
        wishlist_id BIGINT REFERENCES wishlist (id),
        book_id     BIGINT REFERENCES book (id),
        PRIMARY KEY (wishlist_id, book_id)
    );

  views.sql: |
    CREATE MATERIALIZED VIEW books_per_author AS
    SELECT a.id AS author_id, COUNT(b.id) AS book_count
    FROM author a
             LEFT JOIN book b ON a.id = b.author_id
    GROUP BY a.id;

    CREATE MATERIALIZED VIEW authors_per_country AS
    SELECT a.country_id AS country_id, c.name AS country_name, COUNT(*) AS author_count
    FROM author a
             JOIN country c ON a.country_id = c.id
    GROUP BY a.country_id, c.name;
